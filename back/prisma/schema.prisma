
datasource db { 
    provider = "postgresql"
    url = env("DATABASE_URL") 
}

generator client { 
    provider = "prisma-client-js" 
}


enum TxStatus { 
    PENDING 
    SUCCESS 
    FAILED 
    CANCELLED 
}

enum EntryKind { 
    DEPOSIT 
    WITHDRAWAL 
    TRANSFER
    REFUND
    FEE
    ADJUSTMENT
 }

model AppUser {
    id String @id @default(uuid())
    createdAt DateTime @default(now())
    kycLevel Int @default(0)
    accounts Account[]
}


model Account {
    id String @id @default(uuid())
    userId String?
    user AppUser? @relation(fields: [userId], references: [id])
    currency String
    kind String // USER, ESCROW, FEES, RESERVE
    isActive Boolean @default(true)
    entries LedgerEntry[]
    @@unique([userId, currency, kind])
}


model Tx {
    id String @id @default(uuid())
    externalId String?
    idempotencyKey String @unique
    status TxStatus @default(PENDING)
    kind EntryKind
    currency String
    amount Decimal @db.Decimal(18, 6)
    meta Json @default("{}")
    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt
    entries LedgerEntry[]
}


model LedgerEntry {
    id BigInt @id @default(autoincrement())
    txId String
    tx Tx @relation(fields: [txId], references: [id])
    accountId String
    account Account @relation(fields: [accountId], references: [id])
    debit Decimal @db.Decimal(18, 6) @default(0)
    credit Decimal @db.Decimal(18, 6) @default(0)
    currency String
    createdAt DateTime @default(now())
}


model WebhookEvent {
    id BigInt @id @default(autoincrement())
    provider String
    eventId String
    signatureOk Boolean
    payload Json
    receivedAt DateTime @default(now())
    @@unique([provider, eventId])
}